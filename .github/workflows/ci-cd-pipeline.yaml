name: Sock Shop Deployment Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  AWS_REGION: ap-south-1
  EKS_CLUSTER_NAME: dev-sock-shop-eks

jobs:
  validate:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate YAML syntax
        run: |
          echo "Validating Kubernetes manifests..."
          python3 -c '
          import yaml
          import sys
          
          try:
              with open("deploy/kubernetes/complete-demo.yaml", "r") as f:
                  docs = list(yaml.safe_load_all(f))
              print(f"‚úÖ Successfully parsed {len(docs)} Kubernetes resources")
              for i, doc in enumerate(docs):
                  if doc:
                      kind = doc.get("kind", "Unknown")
                      name = doc.get("metadata", {}).get("name", "Unknown")
                      print(f"  - Resource {i+1}: {kind}/{name}")
              sys.exit(0)
          except yaml.YAMLError as e:
              print(f"‚ùå YAML parsing error: {e}")
              sys.exit(1)
          except Exception as e:
              print(f"‚ùå Error: {e}")
              sys.exit(1)
          '

  deploy-staging:
    name: Deploy to Staging (EKS)
    needs: validate
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}
      
      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f deploy/kubernetes/complete-demo.yaml
      
      - name: Wait for deployment
        run: |
          kubectl rollout status deployment/front-end -n sock-shop --timeout=5m
          kubectl get pods -n sock-shop
      
      - name: Get Application URL
        run: |
          LB_URL=$(kubectl -n sock-shop get svc front-end -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          echo "üöÄ Application deployed at: http://$LB_URL"

  deploy-production:
    name: Deploy to Production (EKS)
    needs: validate
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment:
      name: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}
      
      - name: Deploy to Production
        run: |
          kubectl apply -f deploy/kubernetes/complete-demo.yaml
      
      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/front-end -n sock-shop --timeout=5m
          kubectl rollout status deployment/catalogue -n sock-shop --timeout=5m
      
      - name: Verify deployment
        run: |
          kubectl get pods -n sock-shop
          kubectl get svc -n sock-shop
      
      - name: Get Application URL
        run: |
          LB_URL=$(kubectl -n sock-shop get svc front-end -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          echo "‚úÖ Production deployment successful!"
          echo "üåê Application URL: http://$LB_URL"
